import{a2 as _e,f as m,N as P,a8 as S,e as be,x as ke,S as we,c as r,a as t,d as n,g as s,w as b,a4 as ae,p as q,i as qe,F as N,q as Q,s as T,Z as c,j as O,n as se,l as V,k as R,o}from"./index-DA11XDlS.js";import{g as j,u as Ie,I as ze}from"./inventory-C7YLZSJU.js";import{S as Te}from"./store-CWx3Qvm3.js";import{N as Pe,b as X}from"./Tabs-CdCqfdBl.js";import{S as le}from"./search-Cw5mh_gR.js";import{N as ie,C as Ce}from"./chevron-left-DzsXtU2s.js";import{L as D}from"./loader-circle-BnoPFgCr.js";import{P as W}from"./package-CRVIogFf.js";import{C as Z}from"./coins-Ks2rpWqM.js";import{U as ne}from"./user-CXIJJnqr.js";import{C as Le}from"./chevron-right-BzVHn-hR.js";import{c as A}from"./createLucideIcon-DiiZaxVK.js";import{P as F}from"./plus-BY3P3rBe.js";import{X as oe}from"./x-DGyACQy4.js";import{E as xe}from"./eye-DNttFUWn.js";import{C as Me}from"./circle-alert-CQn7xOz3.js";import{u as Se}from"./use-message--i6DiThE.js";import{_ as $e}from"./Input-DOOhwlQ-.js";import{_ as G}from"./InputNumber-tuzvZVlG.js";import{_ as Ue}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./Add-C6IKdIGC.js";import"./use-compitable-BnEdbODL.js";import"./use-merged-state-DvdMjKiF.js";import"./next-frame-once-C5Ksf8W7.js";import"./Tag-D90sLFiK.js";import"./use-locale-EBm6emhn.js";import"./get-DlSqnTrT.js";import"./format-length-B-p6aW7q.js";const Be=A("pen-line",[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);const re=A("shopping-bag",[["path",{d:"M16 10a4 4 0 0 1-8 0",key:"1ltviw"}],["path",{d:"M3.103 6.034h17.794",key:"awc11p"}],["path",{d:"M3.4 5.467a2 2 0 0 0-.4 1.2V20a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6.667a2 2 0 0 0-.4-1.2l-2-2.667A2 2 0 0 0 17 2H7a2 2 0 0 0-1.6.8z",key:"o988cm"}]]);const ue=A("shopping-cart",[["circle",{cx:"8",cy:"21",r:"1",key:"jimo8o"}],["circle",{cx:"19",cy:"21",r:"1",key:"13723u"}],["path",{d:"M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12",key:"9zh506"}]]);const Ne=A("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]),Qe=_e("market",()=>{const $=m([]),g=m([]),u=m({page:1,total:0,totalPages:0}),w=m(!1),I=m(!1),f=m(""),k=m(""),H=P(()=>$.value.length===0),C=P(()=>g.value.length>0),d=async i=>{w.value=!0;try{const p={page:i?.page||1,pageSize:i?.pageSize||20};i?.search&&(p.search=i.search,f.value=i.search),i?.itemType&&(p.itemType=i.itemType,k.value=i.itemType);const{data:h}=await S.getListings(p);return $.value=h.listings||[],u.value={page:h.page,total:h.total,totalPages:h.totalPages},h}finally{w.value=!1}},y=async()=>{I.value=!0;try{const{data:i}=await S.getMyListings();return g.value=i.listings||[],i}finally{I.value=!1}};return{listings:$,myListings:g,pagination:u,loading:w,myListingsLoading:I,searchKeyword:f,filterType:k,isEmpty:H,hasMyListings:C,fetchListings:d,fetchMyListings:y,getListingDetail:async i=>{try{const{data:p}=await S.getListingDetail(i);return p}catch{return null}},createListing:async i=>{const{data:p}=await S.createListing(i);return await y(),p},cancelListing:async i=>{const{data:p}=await S.cancelListing(i);return await Promise.all([y(),d()]),p},purchase:async(i,p)=>{const{data:h}=await S.purchase(i,p);return await d({page:u.value.page,search:f.value||void 0,itemType:k.value||void 0}),h},calculateCost:(i,p)=>i.listingType==="bundle"?i.price:i.price.map(h=>({itemId:h.itemId,quantity:Math.floor(h.quantity/i.quantity)*p})),formatPrice:i=>i.map(p=>`${j(p.itemId)?.name||p.itemId}×${p.quantity}`).join("、"),formatPriceWithTemplates:i=>i.map(p=>`${p.template.name}×${p.quantity}`).join("、"),changePage:async i=>{await d({page:i,search:f.value||void 0,itemType:k.value||void 0})},search:async i=>{f.value=i,await d({page:1,search:i||void 0,itemType:k.value||void 0})},filterByType:async i=>{k.value=i,await d({page:1,search:f.value||void 0,itemType:i||void 0})},resetFilters:async()=>{f.value="",k.value="",await d({page:1})},clear:()=>{$.value=[],g.value=[],u.value={page:1,total:0,totalPages:0},f.value="",k.value=""}}}),We={class:"market-page"},je={class:"page-header"},Ee={class:"header-icon"},Ve={class:"tab-label"},De={class:"tab-content"},Fe={class:"filter-bar"},Ae={key:0,class:"loading-state"},He={key:1,class:"empty-state"},Ke={key:2,class:"listings-grid"},Oe=["onClick"],Re={class:"listing-header"},Xe={key:0,class:"bundle-tag"},Ze={class:"listing-quantity"},Ge={class:"listing-price"},Je={class:"listing-seller"},Ye={key:3,class:"pagination"},et=["disabled"],tt={class:"page-info"},at=["disabled"],st={class:"tab-label"},lt={class:"tab-content"},it={key:0,class:"loading-state"},nt={key:1,class:"empty-state"},ot={key:2,class:"my-listings"},rt={class:"listing-main"},ut={class:"listing-info"},ct={key:0,class:"bundle-tag small"},dt={class:"listing-meta"},pt={class:"meta-item"},mt={class:"meta-item"},vt=["onClick"],yt={class:"tab-label"},ht={class:"tab-content"},gt={class:"list-form"},ft={class:"form-section"},_t={class:"item-selector"},bt={class:"item-count"},kt={key:0,class:"form-section"},wt={class:"form-hint"},qt={key:1,class:"form-section"},It={class:"price-list"},zt=["onClick"],Tt={key:2,class:"listing-preview"},Pt={class:"preview-header"},Ct={class:"preview-content"},Lt={class:"preview-row"},xt={key:0,class:"preview-row"},Mt={class:"preview-value"},St=["disabled"],$t={class:"modal-header"},Ut={class:"item-picker-content"},Bt={key:0,class:"empty-picker"},Nt={key:1,class:"picker-list"},Qt=["onClick"],Wt={class:"picker-item-count"},jt={class:"modal-header"},Et={key:0,class:"purchase-content"},Vt={class:"purchase-item-info"},Dt={class:"purchase-item-desc"},Ft={class:"purchase-seller"},At={key:0,class:"purchase-quantity"},Ht={class:"quantity-hint"},Kt={key:1,class:"bundle-notice"},Ot={class:"purchase-cost"},Rt={class:"cost-header"},Xt={class:"cost-list"},Zt={class:"cost-name"},Gt={class:"cost-quantity"},Jt=["disabled"],Yt=be({__name:"Market",setup($){const g=Se(),u=Qe(),w=Ie(),I=m("browse"),f=m(""),k=m(null),H=[{label:"丹药",value:"consumable"},{label:"材料",value:"material"},{label:"种子",value:"seed"},{label:"图纸",value:"recipe"},{label:"法宝",value:"equipment"},{label:"珍奇",value:"special"}],C=m(!1),d=m(null),y=m(null),_=m([{itemId:null,quantity:null}]),L=m(!1),U=m(!1),v=m(null),x=m(1),M=m(!1),K=P(()=>w.items.filter(l=>(l.template||j(l.itemId))?.tradeable&&!l.isBound)),J=P(()=>Object.values(ze).filter(l=>l.tradeable).map(l=>({label:l.name,value:l.id}))),B=P(()=>{if(!y.value||_.value.length===0)return"bundle";const l=_.value.filter(a=>a.itemId&&a.quantity&&a.quantity>0);return l.length===0?"bundle":l.every(a=>(a.quantity||0)%(y.value||1)===0)?"per_item":"bundle"}),Y=P(()=>B.value!=="per_item"||!y.value?"":_.value.filter(e=>e.itemId&&e.quantity&&e.quantity>0).map(e=>{const a=j(e.itemId),z=Math.floor((e.quantity||0)/(y.value||1));return`${a?.name||e.itemId}×${z}`}).join("、")),ee=P(()=>!d.value||!y.value||y.value<=0?!1:_.value.filter(e=>e.itemId&&e.quantity&&e.quantity>0).length>0),te=P(()=>{if(!v.value)return[];const l=v.value.isBundle?v.value.remainingQuantity:x.value;return u.calculateCost(v.value,l)}),i=l=>({common:"#a8a090",uncommon:"#6b8e7a",rare:"#6b9fc9",epic:"#9b7ab8",legendary:"#c9a959",mythic:"#c96a5a"})[l||"common"]||"#a8a090",p=l=>j(l)?.name||l,h=l=>{if(!l.priceWithTemplates||l.priceWithTemplates.length===0)return"免费";const e=l.priceWithTemplates[0];if(!e)return"免费";let a=`${e.template.name}×${e.quantity}`;return l.priceWithTemplates.length>1&&(a+=` +${l.priceWithTemplates.length-1}种`),a},ce=()=>{u.search(f.value)},de=l=>{u.filterByType(l||"")},pe=l=>{d.value={id:l.id,itemId:l.itemId,quantity:l.quantity,template:l.template||j(l.itemId)},y.value=1,C.value=!1},me=()=>{_.value.push({itemId:null,quantity:null})},ve=l=>{_.value.splice(l,1)},ye=async()=>{if(!d.value||!y.value)return;const l=_.value.filter(e=>e.itemId&&e.quantity&&e.quantity>0).map(e=>({itemId:e.itemId,quantity:e.quantity}));if(l.length===0){g.warning("请设置交换价格");return}L.value=!0;try{const e=await u.createListing({itemId:d.value.itemId,quantity:y.value,price:l});g.success(e.message||"上架成功"),d.value=null,y.value=null,_.value=[{itemId:null,quantity:null}],await w.fetchInventory(),I.value="my-listings"}catch(e){g.error(R(e,"上架失败"))}finally{L.value=!1}},he=async l=>{try{const e=await u.cancelListing(l);g.success(e.message||"下架成功"),await w.fetchInventory()}catch(e){g.error(R(e,"下架失败"))}},ge=l=>{v.value=l,x.value=1,U.value=!0},fe=async()=>{if(v.value){M.value=!0;try{const l=v.value.isBundle?void 0:x.value,e=await u.purchase(v.value.id,l);g.success(e.message||"购买成功"),U.value=!1,await w.fetchInventory()}catch(l){g.error(R(l,"购买失败"))}finally{M.value=!1}}};return ke(I,async l=>{l==="browse"?await u.fetchListings():l==="my-listings"?await u.fetchMyListings():l==="list"&&await w.fetchInventory()}),we(async()=>{await Promise.all([u.fetchListings(),w.fetchInventory()])}),(l,e)=>(o(),r("div",We,[t("div",je,[t("div",Ee,[n(s(Te),{size:24})]),e[12]||(e[12]=t("div",{class:"header-info"},[t("h1",null,"万宝楼"),t("p",null,"天南第一楼，宝换有缘人")],-1))]),n(s(Pe),{value:I.value,"onUpdate:value":e[8]||(e[8]=a=>I.value=a),type:"segment",animated:"",class:"market-tabs"},{default:b(()=>[n(s(X),{name:"browse"},{tab:b(()=>[t("div",Ve,[n(s(le),{size:14}),e[13]||(e[13]=t("span",null,"逛市场",-1))])]),default:b(()=>[t("div",De,[t("div",Fe,[n(s($e),{value:f.value,"onUpdate:value":e[0]||(e[0]=a=>f.value=a),placeholder:"搜索物品...",clearable:"",onKeyup:qe(ce,["enter"])},{prefix:b(()=>[n(s(le),{size:14})]),_:1},8,["value"]),n(s(ie),{value:k.value,"onUpdate:value":[e[1]||(e[1]=a=>k.value=a),de],options:H,placeholder:"类型",clearable:"",style:{width:"100px"}},null,8,["value"])]),s(u).loading?(o(),r("div",Ae,[n(s(D),{size:24,class:"spinning"}),e[14]||(e[14]=t("span",null,"正在加载...",-1))])):s(u).isEmpty?(o(),r("div",He,[n(s(W),{size:48}),e[15]||(e[15]=t("span",null,"暂无在售物品",-1))])):(o(),r("div",Ke,[(o(!0),r(N,null,Q(s(u).listings,a=>(o(),r("div",{key:a.id,class:"listing-card",style:T({"--quality-color":i(a.itemTemplate.quality)}),onClick:z=>ge(a)},[t("div",Re,[t("span",{class:"item-name",style:T({color:i(a.itemTemplate.quality)})},c(a.itemTemplate.name),5),a.isBundle?(o(),r("span",Xe,"捆绑")):q("",!0)]),t("div",Ze,[n(s(W),{size:12}),t("span",null,c(a.remainingQuantity)+" / "+c(a.quantity),1)]),t("div",Ge,[n(s(Z),{size:12}),t("span",null,c(h(a)),1)]),t("div",Je,[n(s(ne),{size:12}),t("span",null,c(a.sellerName),1)])],12,Oe))),128))])),s(u).pagination.totalPages>1?(o(),r("div",Ye,[t("button",{class:"page-btn",disabled:s(u).pagination.page===1,onClick:e[2]||(e[2]=a=>s(u).changePage(s(u).pagination.page-1))},[n(s(Ce),{size:16})],8,et),t("span",tt,c(s(u).pagination.page)+" / "+c(s(u).pagination.totalPages),1),t("button",{class:"page-btn",disabled:s(u).pagination.page>=s(u).pagination.totalPages,onClick:e[3]||(e[3]=a=>s(u).changePage(s(u).pagination.page+1))},[n(s(Le),{size:16})],8,at)])):q("",!0)])]),_:1}),n(s(X),{name:"my-listings"},{tab:b(()=>[t("div",st,[n(s(re),{size:14}),e[16]||(e[16]=t("span",null,"我的货摊",-1))])]),default:b(()=>[t("div",lt,[s(u).myListingsLoading?(o(),r("div",it,[n(s(D),{size:24,class:"spinning"}),e[17]||(e[17]=t("span",null,"正在加载...",-1))])):s(u).hasMyListings?(o(),r("div",ot,[(o(!0),r(N,null,Q(s(u).myListings,a=>(o(),r("div",{key:a.id,class:"my-listing-card",style:T({"--quality-color":i(a.itemTemplate.quality)})},[t("div",rt,[t("div",ut,[t("span",{class:"item-name",style:T({color:i(a.itemTemplate.quality)})},c(a.itemTemplate.name),5),a.isBundle?(o(),r("span",ct,"捆绑")):q("",!0)]),t("div",dt,[t("span",pt,[n(s(W),{size:12}),O(" 剩余 "+c(a.remainingQuantity)+" / "+c(a.quantity),1)]),t("span",mt,[n(s(Z),{size:12}),O(" "+c(s(u).formatPriceWithTemplates(a.priceWithTemplates)),1)])])]),t("button",{class:"cancel-btn",onClick:z=>he(a.id)},[n(s(oe),{size:16}),e[20]||(e[20]=O(" 下架 ",-1))],8,vt)],4))),128))])):(o(),r("div",nt,[n(s(re),{size:48}),e[19]||(e[19]=t("span",null,"你还没有上架任何物品",-1)),t("button",{class:"action-btn",onClick:e[4]||(e[4]=a=>I.value="list")},[n(s(F),{size:16}),e[18]||(e[18]=t("span",null,"上架物品",-1))])]))])]),_:1}),n(s(X),{name:"list"},{tab:b(()=>[t("div",yt,[n(s(F),{size:14}),e[21]||(e[21]=t("span",null,"上架物品",-1))])]),default:b(()=>[t("div",ht,[t("div",gt,[t("div",ft,[e[23]||(e[23]=t("label",{class:"form-label"},"选择物品",-1)),t("div",_t,[d.value?(o(),r("div",{key:0,class:"selected-item",style:T({"--quality-color":i(d.value.template?.quality||"common")}),onClick:e[5]||(e[5]=a=>C.value=!0)},[t("span",{class:"item-name",style:T({color:i(d.value.template?.quality||"common")})},c(d.value.template?.name),5),t("span",bt,"x"+c(d.value.quantity),1),n(s(Be),{size:14,class:"edit-icon"})],4)):(o(),r("button",{key:1,class:"select-btn",onClick:e[6]||(e[6]=a=>C.value=!0)},[n(s(F),{size:18}),e[22]||(e[22]=t("span",null,"选择要上架的物品",-1))]))])]),d.value?(o(),r("div",kt,[e[24]||(e[24]=t("label",{class:"form-label"},"上架数量",-1)),n(s(G),{value:y.value,"onUpdate:value":e[7]||(e[7]=a=>y.value=a),min:1,max:d.value.quantity,placeholder:"输入数量"},null,8,["value","max"]),t("span",wt,"最多可上架 "+c(d.value.quantity)+" 个",1)])):q("",!0),d.value?(o(),r("div",qt,[e[26]||(e[26]=t("label",{class:"form-label"},"交换价格",-1)),t("div",It,[(o(!0),r(N,null,Q(_.value,(a,z)=>(o(),r("div",{key:z,class:"price-item"},[n(s(ie),{value:a.itemId,"onUpdate:value":E=>a.itemId=E,options:J.value,placeholder:"选择物品",filterable:"",style:{flex:"1"}},null,8,["value","onUpdate:value","options"]),n(s(G),{value:a.quantity,"onUpdate:value":E=>a.quantity=E,min:1,placeholder:"数量",style:{width:"100px"}},null,8,["value","onUpdate:value"]),_.value.length>1?(o(),r("button",{key:0,class:"remove-price-btn",onClick:E=>ve(z)},[n(s(oe),{size:14})],8,zt)):q("",!0)]))),128)),t("button",{class:"add-price-btn",onClick:me},[n(s(F),{size:14}),e[25]||(e[25]=t("span",null,"添加价格物品",-1))])])])):q("",!0),d.value&&y.value&&_.value[0]?.itemId?(o(),r("div",Tt,[t("div",Pt,[n(s(xe),{size:14}),e[27]||(e[27]=t("span",null,"挂单预览",-1))]),t("div",Ct,[t("div",Lt,[e[28]||(e[28]=t("span",{class:"preview-label"},"销售类型",-1)),t("span",{class:se(["preview-value",B.value])},c(B.value==="per_item"?"按件出售":"捆绑出售"),3)]),B.value==="per_item"?(o(),r("div",xt,[e[29]||(e[29]=t("span",{class:"preview-label"},"单价",-1)),t("span",Mt,c(Y.value),1)])):q("",!0)])])):q("",!0),d.value?(o(),r("button",{key:3,class:"submit-btn",disabled:!ee.value||L.value,onClick:ye},[L.value?(o(),V(s(D),{key:0,size:16,class:"spinning"})):(o(),V(s(Ne),{key:1,size:16})),t("span",null,c(L.value?"上架中...":"确认上架"),1)],8,St)):q("",!0)])])]),_:1})]),_:1},8,["value"]),n(s(ae),{show:C.value,"onUpdate:show":e[9]||(e[9]=a=>C.value=a),preset:"card",style:{width:"90%","max-width":"400px"}},{header:b(()=>[t("div",$t,[n(s(W),{size:18}),e[30]||(e[30]=t("span",null,"选择物品",-1))])]),default:b(()=>[t("div",Ut,[K.value.length===0?(o(),r("div",Bt,[n(s(W),{size:32}),e[31]||(e[31]=t("span",null,"没有可交易的物品",-1))])):(o(),r("div",Nt,[(o(!0),r(N,null,Q(K.value,a=>(o(),r("div",{key:a.id,class:se(["picker-item",{selected:d.value?.id===a.id}]),style:T({"--quality-color":i(a.template?.quality||"common")}),onClick:z=>pe(a)},[t("span",{class:"picker-item-name",style:T({color:i(a.template?.quality||"common")})},c(a.template?.name),5),t("span",Wt,"x"+c(a.quantity),1)],14,Qt))),128))]))])]),_:1},8,["show"]),n(s(ae),{show:U.value,"onUpdate:show":e[11]||(e[11]=a=>U.value=a),preset:"card",style:{width:"90%","max-width":"400px"}},{header:b(()=>[t("div",jt,[n(s(ue),{size:18}),e[32]||(e[32]=t("span",null,"购买物品",-1))])]),default:b(()=>[v.value?(o(),r("div",Et,[t("div",Vt,[t("div",{class:"purchase-item-name",style:T({color:i(v.value.itemTemplate.quality)})},c(v.value.itemTemplate.name),5),t("div",Dt,c(v.value.itemTemplate.description),1)]),t("div",Ft,[n(s(ne),{size:14}),t("span",null,c(v.value.sellerName),1)]),v.value.isBundle?(o(),r("div",Kt,[n(s(Me),{size:16}),t("span",null,"捆绑销售，需购买全部 "+c(v.value.remainingQuantity)+" 件",1)])):(o(),r("div",At,[e[33]||(e[33]=t("label",null,"购买数量",-1)),n(s(G),{value:x.value,"onUpdate:value":e[10]||(e[10]=a=>x.value=a),min:1,max:v.value.remainingQuantity},null,8,["value","max"]),t("span",Ht,"剩余 "+c(v.value.remainingQuantity)+" 件",1)])),t("div",Ot,[t("div",Rt,[n(s(Z),{size:14}),e[34]||(e[34]=t("span",null,"需要支付",-1))]),t("div",Xt,[(o(!0),r(N,null,Q(te.value,(a,z)=>(o(),r("div",{key:z,class:"cost-item"},[t("span",Zt,c(p(a.itemId)),1),t("span",Gt,"x"+c(a.quantity),1)]))),128))])]),t("button",{class:"purchase-btn",disabled:M.value,onClick:fe},[M.value?(o(),V(s(D),{key:0,size:16,class:"spinning"})):(o(),V(s(ue),{key:1,size:16})),t("span",null,c(M.value?"购买中...":"确认购买"),1)],8,Jt)])):q("",!0)]),_:1},8,["show"])]))}}),Ca=Ue(Yt,[["__scopeId","data-v-735ad1e4"]]);export{Ca as default};
